---
title: "COVID-19"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: united
    favicon: www/favicon.ico
    includes:
      in_header: www/meta.html
    navbar:
      - { title: "<i class='fab fa-github fa-lg'></i> &nbsp; Credits",
          href: "https://github.com/Lrakotoson/Covid-19" }
runtime: shiny

---


```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(rAmCharts)
library(bsplus)
library(shiny.i18n)
```


```{r}
bs_modal(
    id = "modal_markdown", 
    title = "Langue de l'interface",
    selectInput(
      "lang",
      label = h5("Choix de la langue"),
      choices = c(
        "English" = "en",
        "Français" = "fr"
      ),
      selected = "fr"
      )
  )



translator <- Translator$new(translation_csvs_path = "translation")
i18n <- reactive({
    selected <- input$lang
    if (length(selected) > 0 && selected %in% translator$languages) {
      translator$set_translation_language(selected)
    }
    translator
  })
```


```{r global, include=FALSE}
source('scripts/global.R')
source('scripts/evolution.R')
source('scripts/analysis.R')
```


<script>
$(document).ready(function() {
  $('#dashboard-container').on('flexdashboard:layoutcomplete', function() {
    $('#modal_markdown').modal();
  })
})
</script>


Situation mondiale
=======================================================================

Column {data-width=2/3}
-----------------------------------------------------------------------

### Nombre de cas

```{r}
renderPlotly(
 map_evolution("Monde", ncol(T_cas) - 4, "Cas", F, T)
)

```

Column {data-width=1/3}
-----------------------------------------------------------------------
### Cas recencés

```{r}
cas_r <- format(brief()$Cas, big.mark=" ")
positifs_r <- format(brief()$Cas - (brief()$Morts + brief()$Retablis), big.mark=" ")
renderValueBox(
valueBox(cas_r,
         paste(i18n()$t("Cas"), positifs_r, "positifs*"),
         icon = "fa-procedures",
         color="danger"))
```

### Taux** de rétablissement

```{r}
retablis_r <- round(brief()$Retablis*100/brief()$Cas, 2)
valueBox(paste(retablis_r, '%'), icon = "fa-plus", color="success")
```

### Taux** de mortalité

```{r}
morts_r <- round(brief()$Morts*100/brief()$Cas, 2)
valueBox(paste(morts_r, '%'), icon = "fa-dizzy", color="warning")
```

### Actus {.no-title}

```{r}
renderTable({
  suppressWarnings(actus()) %>% rename("A la une" = Actus)
  },sanitize.text.function = function(x) x)
```

>*Positifs = Cas non rétablis, non décédés  
>**Taux = nombre de rétablissements ou morts sur les cas recensés.




Evolution regionale 
=======================================================================

Inputs {.sidebar}
-------------------------------------

<h3>Analyse par région</h3>
L'actualisation de cette variable globale permet la mise à jour des 3 fenêtres.

```{r}
selectInput("region", label = h5("Région:"),
            choices = regions, selected = "Monde")
```

<hr>
<h4>Analyse de la carte</h4>
Analyse de la répartition géographique des __cas__/ __rétablis__/ __morts__ en fonction du __temps__.

```{r}
selectInput("colonne", label = "Situation:",
            choices = c("Cas", "Retablis", "Morts"), selected = "Cas")
```

```{r}
t <- min(ncol(T_cas), ncol(T_retablis), ncol(T_morts)) - 4

sliderInput("time", label = "Relevé:",
            min = 1, max = t, value = t, step = 1)
```

<hr>
<h4>Analyse en fonction du temps</h4>
Rendre compte des échelles de grandeur:

```{r}
checkboxInput("logscale", "Echelle logarithmique", value = FALSE)
```

__Ajustement de la période sous chaque graphe.__

Row {data-height=1/2}
-------------------------------------

### Situation géographique

```{r}
renderPlotly(
  map_evolution(input$region, input$time, input$colonne)
)
```

   
### Evolution dans la région

```{r}
renderAmCharts(ts_evolution(input$region, input$logscale))
```   

Row {data-height=1/2}
-------------------------------------

### Nouvelles données

```{r}
renderAmCharts(
  nw_evolution(input$region, input$colonne)
)
```
    
### Taux

```{r}
renderAmCharts(rate_evolution(input$region))
```


Analyse par pays {style="position:relative"}
=======================================================================

```{r reactive, include=FALSE}
first <- as.Date(colnames(T_cas)[5], "%m/%d/%y")
last <- as.Date(colnames(T_cas)[ncol(T_cas)], "%m/%d/%y")
rangeDate <- reactive({seq.Date(as.Date(first), as.Date(last), by = "day")})
beg <- reactive({match(as.Date(input$Comparedate[1]), rangeDate())})
end <- reactive({match(as.Date(input$Comparedate[2]), rangeDate())})
Country1 <- reactive({input$Country1})
Country2 <- reactive({input$Country2})
```

Row {style="height:120pc;"}
-------------------------------------



```{r}
fillCol(
  flex = c(0.8, 0.1,
           1.2, 0.1,
           1.2, 0.1,
           1.2, 0.1,
           1.2, 0.1),
  
  fillRow(
    column(
      12,
      selectInput(
        "Country1", "Pays A",
        c(brief("Country")$group, "Monde"),
        "France"
        ),
      selectInput(
        "Country2", "Pays B",
        c(brief("Country")$group, "Monde"),
        "Italy"
       ),
      sliderInput(
        "Comparedate", "Domaine",
        min = first, 
        max = last,
        value = c(first, last), 
        timeFormat = "%d/%m"
       )
    ),
    column(
      12,
      h3("Analyse Cas"),
      checkboxInput(
        "Caslog", "Echelle logarithmique nombre Cas", value = T
      ),
      selectInput(
        "Casreg",
        "Régression Cas",
        c("Aucune" = 0,
          "Régression linéaire" = 1,
          "Régression poly 2" = 2,
          "Régression poly 3" = 3
          )
      ),
      textInput(
        "Caspred",
        "Nombre jours à prédire",
        value = 0
      )
    ),
    column(
      12,
      h3("Analyse Décès"),
      checkboxInput(
        "Mortslog", "Echelle logarithmique Mortalité", value = F
      ),
      selectInput(
        "Mortsreg",
        "Régression Mortalité",
        c("Aucune" = 0,
          "Régression linéaire" = 1,
          "Régression poly 2" = 2,
          "Régression poly 3" = 3
        )
      ),
      textInput(
        "Mortspred",
        "Nombre jours à prédire",
        value = 0
      )
    ),
    column(
      12,
      h3("Analyse Rétablis"),
      checkboxInput(
        "Retablislog", "Echelle logarithmique Retablis", value = F
      ),
      selectInput(
        "Retablisreg",
        "Régression Retablis",
        c("Aucune" = 0,
          "Régression linéaire" = 1,
          "Régression poly 2" = 2,
          "Régression poly 3" = 3
        )
      ),
      textInput(
        "Retablispred",
        "Nombre jours à prédire",
        value = 0
      )
    )
  ),br(),
  
  fillRow(
    renderLeaflet({
      comparemap(Country1(), Country2(), end())
    })
  ),br(),
  
  fillRow(
    column(
      12,
      renderAmCharts({
        compare_situation(
          "Cas",
          Country1(), Country2(),
          beg(), end(),
          input$Caslog,
          as.integer(input$Casreg),
          as.integer(input$Caspred)
        )
      })
    ),
    column(
      12,
      renderAmCharts({
        compare_situation(
          "Actifs",
          Country1(), Country2(),
          beg(), end(),
          logscale = F,
          reg = 0, pred = 0
        )
      })
    )
  ),br(),
  
  fillRow(
    column(
      12,
      renderAmCharts({
        compare_situation(
          "Morts",
          Country1(), Country2(),
          beg(), end(),
          input$Mortslog,
          as.integer(input$Mortsreg),
          as.integer(input$Mortspred)
        )
      })
    ),
    column(
      12,
      renderAmCharts({
        compare_situation(
          "Letalite",
          Country1(), Country2(),
          beg(), end(),
          input$Mortslog,
          as.integer(input$Mortsreg),
          as.integer(input$Mortspred)
        )
      })
    )
  ),br(),
  
  fillRow(
    column(
      12,
      renderAmCharts({
        compare_situation(
          "Retablis",
          Country1(), Country2(),
          beg(), end(),
          input$Retablislog,
          as.integer(input$Retablisreg),
          as.integer(input$Retablispred)
        )
      })
    ),
    column(
      12,
      renderAmCharts({
        compare_new(
          Country1(), Country2(),
          beg(), end()
        )
      })
    )
  ),br()
  
)
```
